<script>
$(function() {
  //declare variables
	var name = $( "#name" ),
	requester = $( "#requester" ),
	dueDate = $( "#dueDate" ),
	owner = $( "#owner" ),
	creator = $( "#creator" ),
	assignee = $( "#assignee" ),
	priority = $( "#priority" ),
	createTaskForm = $( "#createTask" ),
	submitButton = $( "#postTask" ),
	postObject = {};
	
	function onFailure(return_obj) {
        console.log('failed!');
		console.log(return_obj.message);
        submitButton.prop("disabled",false);
	}
	
	function onSuccessCreate(return_obj) {
		$(':input','#createTask').not(':button, :submit, :reset, :hidden')
								 .val('')
								 .removeAttr('checked')
								 .removeAttr('selected');
		submitButton.prop("disabled",false);
		console.log(return_obj[0].objectId);
	}
	
    function fixDate(date) {
      return date.replace(/-/g,"/");
    }
    
	function onSuccessUpload(return_obj) {
		postObject.Name = name.val();
		postObject.Requester = requester.val();
		postObject.DueDate = fixDate(dueDate.val());
		postObject.Owner = owner.val();
		postObject.Creator = creator.val();
		postObject.Assignee = assignee.val();
		postObject.Priority = priority.val();
        postObject.FileUrl = return_obj[1];
        postObject.FileName = return_obj[0];
		google.script.run.withSuccessHandler(onSuccessCreate)
	                     .withFailureHandler(onFailure)
	                     .postTask(postObject);
	}
	
	submitButton.click(function(event) {
		event.preventDefault();
        $(this).prop("disabled",true);
        var count = validate(true);
        if(count > 0) {
          $(this).prop("disabled",false);
        } else {
          google.script.run.withSuccessHandler(onSuccessUpload)
                           .withFailureHandler(onFailure)
                           .uploadFile(document.getElementById("createTask"));
        }
	});
	
	$("#createTask input").on('blur', function() {
		validate(false, $(this));
	});
    
    function validate(wholeForm, input) {
      var count = 0,
      pattern,
      id,
      value,
      result,
      element,
      selector;
      
      //check to see if validition is for the whole form or just single input.
      if(wholeForm) {
      	element = $("#createTask input");
      } else {
      	element = input;
      }
      
      element.each(function() {
        var $this = $(this);
        pattern = new RegExp($this.attr('pattern'));
        id = $this.attr('id');
        selector = $('#' + id); 
        if(pattern == undefined) { //no pattern defined
          selector.addClass('error');
          count++;
        } else {            
            if(!$this.val()) { //no value
              selector.addClass('error');
              count++;
            } else { //do some actual validation
              value = $this.val();
              result = pattern.test(value);
              if(!result) {//does not match pattern.
              	selector.addClass('error');
                count++;
              } else { //all ok
              	selector.removeClass('error');
              }
            }            
        }
      });
      
      return count;
    }
});
</script>