<script>
//list of variables (names of fields & their corresponding hidden paragraphs for storing messages about whether all is OK.
$(function() {
var taskName = $( "#taskName" ), 
dueDate = $( "#dueDate" ),
requestingOffice = $( "#requestingOffice" ),
taskOwner = $( "#taskOwner" ),
assignTaskTo = $( "#assignTaskTo" ),
priority = $( "#priorityPickList" ),
category = $( "#checkboxes" ),
attachment = $( "#attachments_url" ),
attachmentUpload = $( "#attachments_upload" ),
attachmentUrlTitle = $( "#attachmentUrlTitle" ),
lastAction = $( "#lastAction" ), 
attachmentUrlId = $( "#attachmentsUrlConfirm" ),
stakeholders = $( "#stakeholders" ),
tags = $( "#tags" ),
taskNameTips = $( "#taskNameTips" ), 
dueDateTips = $( "#dueDateTips" ),
requestingOfficeTips = $( "#requestingOfficeTips" ),
taskOwnerTips = $( "#taskOwnerTips" ),
assignTaskToTips = $( "#assignTaskToTips" ),
priorityTips = $( "#priorityPickListTips" ),
categoryTips = $( "#categoryTips" ),
validateTips = $( "#validateTips" ),
attachmentTips = $( "#attachmentTips" ),
lastActionTips = $( "#lastActionTips" ),
attachmentUrlTitleTips = $( "#attachmentUrlTitleTips" ),
stakeholdersTips = $( "#stakeholdersTips" ),
tagsTips = $( "#tagsTips" ),
categoryArray = new Array(),
counter = 0,
totalCounter = 0,
assigneeCounter = 0,
ownerCounter = 0,
keywordArray = new Array(),
assigneeArray = new Array(),
ownerArray = new Array(),
taskDescription = $( "#taskDescription" ),
activityDate = $( "#activityDate" );

//get values of all checked boxes
  function getCheckBoxData() {
    categoryArray.length = 0;
    $('input[name="category"]:checked').each(function() {
      categoryArray.push($(this).val());
    });
  }

//get file values for saving purposes
  function getFilesForSaving() {
    var fileArray = [];
    $( "#documentUploadList ol li a").each(function() {
      var urlNameObj = {};
      var url = $(this).attr('href');
      var name = $(this).html();
      urlNameObj.name = name;
      urlNameObj.url = url;
      fileArray.push(urlNameObj);
    });
    return fileArray;
  }

//gets all assignees
  function getAssigneeArray() {
    assigneeArray = [];
    $("ul.assigneeList li").each(function() {
      var leadIndex = $(this).text().indexOf('(Lead)');
      if(leadIndex > 0) {
        var newStr = $(this).text().split('(Lead)')[0];
        assigneeArray.push($.trim(newStr));
      } else {
        assigneeArray.push( $.trim($(this).text()) );
      }
    });
    return assigneeArray;
  }
  
//gets all owners
  function getOwnerArray() {
    ownerArray = [];
    $("ul.ownerList li").each(function() {
      var leadIndex = $(this).text().indexOf('(Lead)');
      if(leadIndex > 0) {
        var newStr = $(this).text().split('(Lead)')[0];
        ownerArray.push($.trim(newStr));
      } else {
        ownerArray.push( $.trim($(this).text()) );
      }
    });
    return ownerArray;
  }  

function addKeywordRemoveKeyword(keyword) {
  if(counter < 10 && keyword != '' && keyword.indexOf(',') === -1) {
    counter++;
    var currentKeywords = $('.keywordList');
    currentKeywords.css("display", "block");
    var newKeyword = keyword.toLowerCase();
    var removeKeyword = '<a href="#" style="float:right;" class="ui-icon ui-icon-closethick ui-state-default ui-corner-all removeKeyword"></a>';
    $( currentKeywords ).append( '<li class="keywordListItem" id="keywordz"style="margin-bottom: 3px;">' + newKeyword + removeKeyword + '</li>' );
    $( tags ).val('');
    $( ".removeKeyword" ).bind('click', function() {
      counter--;
      $(this).parent().remove();
    });
    return true;
  } else {
    var errorMsg = 'Please be sure to remove any "," from the Keywords field. Remember no more than five (5) keywords and you must enter at least one (1).';
    return errorMsg;
  }
  
}

//do the list building part of keywords
  $( tags ).bind('keypress', function addKeyword(e) {
    if(e.keyCode==13) { //Enter keycode
      addKeywordRemoveKeyword($( tags ).val());
    }    
  });

//same keyword building but with button
  $( "#addKeyword" ).click(function() {
    addKeywordRemoveKeyword($( tags ).val());
  });

//autocomplete version of assignee building
  $( tags ).on( "autocompleteselect", function(event, ui) {
    var tagsCheck = addKeywordRemoveKeyword(ui.item.value);
    if(tagsCheck === true) {
      $(this).val('');
      event.preventDefault();
      return false;
    } else {
      alert(tagsCheck);
    }
  });
  
//fancy sortable feature for assignee
  $(".assigneeList").sortable({
    forcePlaceholderSize: true,
    placeholder: "ui-state-highlight",
    update: function( event, ui ) {
    $( ".assigneeList" ).find("li").eq(0).find(".lead_assignee").remove(); //<-- Lead
    $( ".assigneeList" ).find("li").eq(0).find("a").before(" <span class='lead_assignee'>(Lead)</span> "); //<-- Lead
    $( ".assigneeList" ).find("li:gt(0)").find(".lead_assignee").remove(); //<-- Everyone else
  }
    }).disableSelection();

//function that does all the work to add/remove assignees. Several calls to it elsewhere.
function addAssigneeAndRemoveAssignee(assignee, auto) {
  if(auto) {
    var emailOK = checkEmail(assignTaskTo, "Assignee", assignTaskToTips, assignee);
  } else {
    emailOK = checkEmail(assignTaskTo, "Assignee", assignTaskToTips);
  }
  var currentAssigneeList = getAssigneeArray();
  var currentAssigneeListString = currentAssigneeList.join(',')
  var index = currentAssigneeListString.indexOf(assignee);
  //checks for blank values, valid email, no repeats and less than 20 assignees
  if(assignee != '' && emailOK === true && index === -1 && assigneeCounter < 20) {
    assigneeCounter++;
    var currentAssignees = $('.assigneeList');
    currentAssignees.css("display", "block");
    var newAssignee = assignee.toLowerCase();
    var removeAssignee = '<a href="#" style="float:right;" class="ui-icon ui-icon-closethick ui-state-default ui-corner-all removeAssignee"></a>';
    $( currentAssignees ).append( '<li class="assigneeListItem" id="assigneez" style="margin-bottom: 3px;">' + newAssignee + removeAssignee + '</li>' );
    if(assigneeCounter === 1 && $("ul.assigneeList li:first-child").html().indexOf('Lead') === -1) { 
      $("ul.assigneeList li:first-child").append( "<span class='lead_assignee'>(Lead)</span>" ); 
    }
    assignTaskTo.val('');
    $( ".removeAssignee" ).bind('click', function() {
      assigneeCounter--;
      $(this).parent().remove();
    });
    return true;
  } else if(index === -1 && emailOK != true){
    var errorMsg = 'Please enter a valid email address';
    return errorMsg;
  } else { 
    errorMsg = 'Assignee already exists in the list'; 
    return errorMsg;
  }      
  
}

//do the list building part for assignees
  $( assignTaskTo ).bind('keypress', function addAssignee(e) {
    if(e.keyCode==13) { //Enter keycode
      addAssigneeAndRemoveAssignee($( assignTaskTo ).val());
    }//end enter keycode if
  });

//same assignee building but with button
  $( "#addAssignee" ).click(function() {
    addAssigneeAndRemoveAssignee($( assignTaskTo ).val());
  });

//autocomplete version of assignee building
  $( assignTaskTo ).on( "autocompleteselect", function(event, ui) {
    var assigneeCheck = addAssigneeAndRemoveAssignee(ui.item.value, true);
    if(assigneeCheck === true) {
      $(this).val('');
      event.preventDefault();
      return false;
    } else {
      alert(assigneeCheck);
    }
  });

//fancy sortable feature for owners
  $(".ownerList").sortable({
    forcePlaceholderSize: true,
    placeholder: "ui-state-highlight",
    update: function( event, ui ) {
    $( ".ownerList" ).find("li").eq(0).find(".lead_owner").remove(); //<-- Lead
    $( ".ownerList" ).find("li").eq(0).find("a").before(" <span class='lead_owner'>(Lead)</span> "); //<-- Lead
    $( ".ownerList" ).find("li:gt(0)").find(".lead_owner").remove(); //<-- Everyone else
  }
    }).disableSelection();

//function that does all the work to add/remove owners. Several calls to it elsewhere.
  function addOwnerAndRemoveOwner(owner, auto) {
    if(auto) {
      var emailOK = checkEmail(taskOwner, "Owner", taskOwnerTips, owner);
    } else { 
      var emailOK = checkEmail(taskOwner, "Owner", taskOwnerTips);
    }
    var currentOwnerList = getOwnerArray();
    var currentOwnerListString = currentOwnerList.join(',')
    var index = currentOwnerListString.indexOf(owner);
    //checks for blank values, valid email, no repeats and less than 20 owners
    if(index >= 0) {
      var errorMsg = 'Owner already exists in the list'; 
      return errorMsg;
    } else if(owner != '' && emailOK === true && index === -1 && ownerCounter < 20) {
      ownerCounter++;
      var currentOwners = $('.ownerList');
      currentOwners.css("display", "block");
      var newOwner = owner.toLowerCase();
      var removeOwner = '<a href="#" style="float:right;" class="ui-icon ui-icon-closethick ui-state-default ui-corner-all removeOwner"></a>';
      $( currentOwners ).append( '<li class="ownerListItem" id="ownerz" style="margin-bottom: 3px;">' + newOwner + removeOwner + '</li>' );
      taskOwner.val('');
      if(ownerCounter === 1 && $("ul.ownerList li:first-child").html().indexOf('Lead') === -1) { 
        $("ul.ownerList li:first-child").append( "<span class='lead_owner'>(Lead)</span>" ); 
      }
      $( ".removeOwner" ).bind('click', function() {
        ownerCounter--;
        $(this).parent().remove();
      });
      return true;
    } else if(index === -1 && emailOK != true){
      errorMsg = 'Please enter a valid email address';
      return errorMsg;
    } 
  }

//do the list building part for owners
  $( taskOwner ).bind('keypress', function addOwner(e) {
    if(e.keyCode==13) { //Enter keycode
      addOwnerAndRemoveOwner(taskOwner.val());
    }//end enter keycode if
  });

//same owner building but with button
  $( "#addOwner" ).click(function() {
    addOwnerAndRemoveOwner(taskOwner.val());
  });

//autocomplete version of owner building
  $(  taskOwner ).on( "autocompleteselect", function(event, ui) {
    var ownerCheck = addOwnerAndRemoveOwner(ui.item.value, true);
    if(ownerCheck === true) {
      $(this).val('');
      event.preventDefault();
      return false;
    } else {
      alert(ownerCheck);
    }
  });
  
$( "#doc-manager-dialog-create-form" ).dialog({
    autoOpen: false,
    resizable: false,
    height:430,
    width:550,
    modal: false
});  

$( "#documentUpload" ).click(function() {
  $( "#doc-manager-dialog-create-form" ).dialog({
    autoOpen: false,
    resizable: false,
    height:430,
    width:550,
    modal: false,
    beforeClose: function() {
      $( ".url_name, .url_url" ).val('');
      $( "#add_attach_ss_upload_form_create")[0].reset();
    },
    buttons: {
      "OK": function() { 
        $( "#documentUploadList" ).empty();
        var listClone = $("#doc-manager-dialog-create-form ol").clone();
        listClone.appendTo( "#documentUploadList" );
//        $( ".remove_attachment" ).click(function(){ $(this).parent().remove(); });
//        $("#doc-manager-dialog-create-form ol").empty();
        $( "#documentUploadList ol li span" ).hide();
        $( this ).dialog( "close" );     
      },
      Cancel: function() {
        $("#doc-manager-dialog-create-form ol").empty();
        var clonedData = $(this).data('clone');
        $("#doc-manager-dialog-create-form ol").replaceWith(clonedData);
        $( "#doc-manager-dialog-create-form ol li span" ).show();
//        $( ".remove_attachment" ).click(function(){ $(this).parent().remove(); });
        $( this ).dialog( "close" );
      }
    }
  });
  
  if($('#documentUploadList ol li').length) {
    var clonedData = $( "#documentUploadList ol" ).clone();
    $( "#doc-manager-dialog-create-form" ).data('clone', clonedData)
                                          .dialog( "open" );
  } else {
    $( "#doc-manager-dialog-create-form" ).dialog( "open" );
  }
  });

  $( activityDate ).datepicker({
      changeMonth: true,
      changeYear: true,
      numberOfMonths: 1
    });

//on blur validation
  $( taskName ).change(function(){
    var returnValue = checkForBlankFields(taskName, "Task Name", taskNameTips);
    if(returnValue !== true) { updateTips( returnValue, taskNameTips); }
  });
  $( dueDate ).datepicker({
      changeMonth: true,
      changeYear: true,
      numberOfMonths: 1
    })
    .change(function(){
      var returnValue = checkForBlankFields(dueDate, "Due Date", dueDateTips);
      if(returnValue !== true) { updateTips( returnValue, dueDateTips); }
  });
  $( requestingOffice ).change(function(){
    var returnValue = checkForBlankFields(requestingOffice, "Requesting Office", requestingOfficeTips);
    if(returnValue !== true) { updateTips( returnValue, requestingOfficeTips); }
  });
  $( priority ).change(function(){
    var returnValue = checkForBlankFields(priority, "Priority", priorityTips);
    if(returnValue !== true) { updateTips( returnValue, priorityTips); }
  });
  $( stakeholders ).change(function(){
    var returnValue = checkForBlankFields(stakeholders, "Stakeholders", stakeholdersTips);
    if(returnValue !== true) { updateTips( returnValue, stakeholdersTips); }
  });
  $( tags ).change(function(){
    var returnValue = checkArray(tags, "Keywords", tagsTips, keywordArray);
    if(returnValue !== true && counter > 1) { updateTips( returnValue, tagsTips); }
  });
  $( tags ).bind('keypress',function(e){
    $("#category-autocomplete-container").show();
  });
  
  $( '#checkboxes input[type=checkbox]' ).change(function(){
    var returnValue = checkCheckBox(category, "Category", categoryTips);
    if(returnValue !== true) { updateTips( returnValue, categoryTips); }
  });
  $( taskOwner ).change(function(){
    var returnValue = checkEmail(taskOwner, "Owner", taskOwnerTips);
//    var len = $('.ownerList > li').length;
    if(returnValue !== true) { updateTips( returnValue, taskOwnerTips); }
  });
  $( assignTaskTo ).change(function(){
    var returnValue = checkEmail(assignTaskTo, "Assignee", assignTaskToTips);
//    var len = $('.ownerList > li').length;
    if(returnValue !== true) { updateTips( returnValue, assignTaskToTips); }
  });

// do the autocompleting thing for assignee & owner field
  function autoSuccess(return_obj) {
    $( '#taskOwner, #assignTaskTo, .task-owner-field' ).autocomplete({ 
      position: { my : "right top", at: "right bottom" },
      source: return_obj
    });
    $( '#add_user_popup' ).autocomplete({ 
      position: { my : "right top", at: "right bottom" },
      source: return_obj 
    });
    }
    google.script.run.withSuccessHandler(autoSuccess).getGroupAutoComplete();
  
//do autocomplete for keyword field
var categoryArray = ['information technology','legislative affairs','financial/budget','gaming','human capital','justice services','public affairs','natural resources','economic development','tribal government','trust','education'];
  function autoSuccessKeyword(return_obj) {
    $( '#tags' ).autocomplete({ 
      position: { my : "left top", at: "left bottom" },
      source: return_obj
//      open: function(event, ui) {
//        var len = categoryArray.length -1;
//        var fullHtml = '';
//        for(var i=0; i<categoryArray.length; i++) {
//          var listItem = '<li class="category-menu-item" role="presentation"><a class="ui-corner-all category-autocomplete" tabindex="-1">' + categoryArray[i] + '</a></li>';
//          if(i===0) {
//            fullHtml += '<div id="category-autocomplete-container"><li class="category-autocomplete-header">Categories</li>' + listItem;
//          } else if(i===len) {
//            fullHtml += '</div>';
//          } else {
//            fullHtml += listItem; 
//          }
//        }
//        $('.ui-autocomplete').append(fullHtml);
//        $( '.category-autocomplete' ).bind('click',function() {
//          var text = $(this).text();
//          addKeywordRemoveKeyword(text);
//          $(".ui-menu-item").hide();
//        });
//      }
    });
  }
  google.script.run.withSuccessHandler(autoSuccessKeyword).getGroupAutoComplete("keyword");

//handle submit button stuff
  $( "#saveUserAction" ).click(function(){
    //get files for saving and sharing
    var allFiles = getFilesForSaving();
    //reset success counter
    var successCounter = 0;
    //deal with keyword & assignee arrays
    var actualKeywordArray = [];
    $("ol.keywordList li").each(function() {
      actualKeywordArray.push( $(this).text() );
    });
    var keywords = actualKeywordArray.join(', ');
    assigneeArray = [];
    $("ul.assigneeList li").each(function() {
      var leadIndex = $(this).text().indexOf('(Lead)');
      if(leadIndex > 0) {
        var newStr = $(this).text().split('(Lead)')[0];
        assigneeArray.push($.trim(newStr));
      } else {
        assigneeArray.push( $.trim($(this).text()) );
      }
    });
    ownerArray = [];
    $("ul.ownerList li").each(function() {
      var leadIndex = $(this).text().indexOf('(Lead)');
      if(leadIndex > 0) {
        var newStr = $(this).text().split('(Lead)')[0];
        ownerArray.push($.trim(newStr));
      } else {
        ownerArray.push( $.trim($(this).text()) );
      }
    });
    
    if(activityDate.val() == '') {
      var activityDateVal = 'No Date';
    } else {
      activityDateVal = activityDate.val();
    }
    updateTips( "Submitting Task...", validateTips );
    
    //go through validation checks so that all the red fields show up at once instead of 1 at a time
    var taskNameCheck = checkForBlankFields(taskName, "Task Name", taskNameTips);
    var dueDateCheck = checkForBlankFields(dueDate, "Due Date", dueDateTips);
    var requestingOfficeCheck = checkForBlankFields(requestingOffice, "Requesting Office", requestingOfficeTips);
    var priorityCheck = checkForBlankFields(priority, "Priority", priorityTips);
    var stakeholdersCheck = checkForBlankFields(stakeholders, "Stakeholders", stakeholdersTips);
    var tagsCheck = checkArray(tags, "Keywords", tagsTips, actualKeywordArray);
    var checkBoxCheck = checkCheckBox(category, "Category", categoryTips);
    var ownerEmailCheck = checkArray(taskOwner, "Task Owner", taskOwnerTips, ownerArray);
    var assigneeEmailCheck = checkArray(assignTaskTo, "Assignee", assignTaskToTips, assigneeArray);
    
    //this portion checks that all fields return true. If they don't the successCounter increments and causes the submit action to cancel later on.
    //the else part fixes a bug where if the field was ever invalid when pressing submit it would keep that error message after successful submit.
    if(taskNameCheck !== true) { successCounter++; updateTips( taskNameCheck, taskNameTips);} else { updateTips( " ", taskNameTips); }
    if(dueDateCheck !== true) { successCounter++; updateTips( dueDateCheck, dueDateTips);} else { updateTips( " ", dueDateTips); }
    if(requestingOfficeCheck !== true) { successCounter++; updateTips( requestingOfficeCheck, requestingOfficeTips);} else { updateTips( " ", requestingOfficeTips); }
    if(stakeholdersCheck !== true) { successCounter++; updateTips( stakeholdersCheck, stakeholdersTips);} else { updateTips( " ", stakeholdersTips); }
    if(ownerEmailCheck !== true) { successCounter++; updateTips( ownerEmailCheck, taskOwnerTips);} else { updateTips( " ", taskOwnerTips); }
    if(assigneeEmailCheck !== true) { successCounter++; updateTips( assigneeEmailCheck, assignTaskToTips); } else { updateTips( " ", assignTaskToTips); }
    if(priorityCheck !== true) { successCounter++; updateTips( priorityCheck, priorityTips);} else { updateTips( " ", priorityTips); }
    if(checkBoxCheck !== true) { successCounter++; updateTips( checkBoxCheck, categoryTips);} else { updateTips( " ", categoryTips); }
    if(tagsCheck !== true) { successCounter++; updateTips( tagsCheck, tagsTips);} else { updateTips( " ", tagsTips); }
    
    //disable fields & submit
    $("input").attr("disabled", "disabled");
    //What happens on a successful submission (mostly messages, resetting form, changing classes, re-enabling fields)
      function onSuccess(return_obj) {
        //share files that were uploaded
        function onSuccessShare() {
          updateTips( '', validateTips);
        }
        google.script.run.withSuccessHandler(onSuccessShare).addAssigneesAndOwnersToDocumentsOnSave(return_obj);
        
        //write new data to autocomplete object, re-run autocomplete so new values are in the fields.
        function onSuccessWrite(auto_return) { 
          google.script.run.withSuccessHandler(autoSuccess).getGroupAutoComplete();
        }
        google.script.run.withSuccessHandler(onSuccessWrite).writeToScriptDB(ownerArray);
        google.script.run.withSuccessHandler(onSuccessWrite).writeToScriptDB(assigneeArray);
        
        function onSuccessWriteKeyword(auto_return_keyword) { 
          google.script.run.withSuccessHandler(autoSuccessKeyword).getGroupAutoComplete("keyword");
        }
        google.script.run.withSuccessHandler(onSuccessWriteKeyword).writeToScriptDBKeyword(keywords);
        
        //send out email notification to assignee
        var emailSubject = 'New Assigned Task - ';
        google.script.run.sendEmailNotification(ownerArray.join(', '), assigneeArray, taskName.val(), dueDate.val(), priority.val(), emailSubject, true);
        google.script.run.sendEmailNotification(ownerArray.join(', '), assigneeArray, taskName.val(), dueDate.val(), priority.val(), emailSubject, false);
        var updateText =  'Your task ' + taskName.val() + ' has been successfully submitted!';
        updateTips( updateText, validateTips ); //notify user that the save was successful

        //clean-up the form
        $("input, textarea").removeAttr("disabled", "disabled").removeClass( "ui-state-default" );
        $("#checkboxes, #priorityPickList").removeClass( "ui-state-default" );
        $( "#saveUserAction" ).addClass( "ui-state-default");
        $("[id$=Tips]").removeClass( "ui-icon ui-icon-check" );
        $('#taskForm')[0].reset();
        $(".keywordListItem").remove();
        $(".assigneeListItem").remove();
        $(".ownerListItem").remove();
        $("#documentUploadList").empty();
        $("#doc-manager-dialog-create-form ol").empty();
        counter = 0;
        
        //refresh report views
        loadMyCreatedDataTable();
        loadMyAssignedDataTable();
      }
      //what happens on a failed submission. Re-enable fields & show the message about why it failed.
      function onFailure(error) {
        updateTips( error.message, validateTips ); //notify user that there was an issue
        $("input, textarea").removeAttr("disabled", "disabled");
      }
      //the check to make sure all validation is okay before executing the write function. 
      if(successCounter===0) {
        $("input, textarea").attr("disabled", "disabled");
        getCheckBoxData();
        google.script.run.withSuccessHandler(onSuccess)
                         .withFailureHandler(onFailure)
                         .submitComment(taskName.val(), dueDate.val(), requestingOffice.val(), ownerArray, assigneeArray, priority.val(), categoryArray, lastAction.val(), activityDateVal, stakeholders.val(), keywords, taskDescription.val(), allFiles);
      } else {
        $("input, textarea").removeAttr("disabled", "disabled")
        updateTips( "Please fix the fields marked in red", validateTips );
      }
  });

  //tooltips function. Adds location of tooltip.
  $(function() {
    $( document ).tooltip({ show: {effect: "slide"}, position: { my: "left+15 center", at: "right center" }, hide: {effect: "slide", direction: "left"} });
  });
});
</script>