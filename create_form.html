<script>
$(function() {
	var name = $( "#name" ),
	requester = $( "#requester" ),
	dueDate = $( "#dueDate" ),
	owner = $( "#owner" ),
	creator = $( "#creator" ),
	assignee = $( "#assignee" ),
	priority = $( "#priority" ),
	createTaskForm = $( "#createTask" ),
	submitButton = $( "#postTask" ),
	postObject = {};
	
	function onFailure(return_obj) {
        console.log('failed!');
		console.log(return_obj.message);
        submitButton.prop("disabled",false);
	}
	
	function onSuccessCreate(return_obj) {
		$(':input','#createTask').not(':button, :submit, :reset, :hidden')
								 .val('')
								 .removeAttr('checked')
								 .removeAttr('selected');
		submitButton.prop("disabled",false);
		console.log(return_obj[0].objectId);
	}
	
    function fixDate(date) {
      return date.replace(/-/g,"/");
    }
    
	function onSuccessUpload(return_obj) {
		postObject.Name = name.val();
		postObject.Requester = requester.val();
		postObject.DueDate = fixDate(dueDate.val());
		postObject.Owner = owner.val();
		postObject.Creator = creator.val();
		postObject.Assignee = assignee.val();
		postObject.Priority = priority.val();
        postObject.FileUrl = return_obj[1];
        postObject.FileName = return_obj[0];
		google.script.run.withSuccessHandler(onSuccessCreate)
	                     .withFailureHandler(onFailure)
	                     .postTask(postObject);
	}
	
	submitButton.click(function(event) {
		event.preventDefault();
        $(this).prop("disabled",true);
        var count = validate();
        if(count > 0) {
          $(this).prop("disabled",false);
          alert('nope!');
        } else {
          google.script.run.withSuccessHandler(onSuccessUpload)
                           .withFailureHandler(onFailure)
                           .uploadFile(document.getElementById("createTask"));
        }
	});
    
    function validate() {
      var count = 0,
      pattern,
      id,
      value;
      
      $("#createTask input").each(function() {
        var $this = $(this);
        pattern = new RegExp($this.attr('pattern'));
        id = console.log($this.attr('id'));
        if(pattern == undefined) { //no pattern defined
          count++;
        } else {            
            if(!$this.val()) { //no value
              count++;
            } else { //do some actual validation
              value = $this.val();
              var result = pattern.test(value);
              if(!result) {//does not match pattern.
                count++;
              }
            }            
        }
      });
      
      console.log(count);
      return count;
    }
});
</script>
